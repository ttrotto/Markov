<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.55">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Tommaso Trotto &amp; Jen Baron (tommaso.trotto@ubc.ca)">
<meta name="dcterms.date" content="2024-11-06">

<title>GEM500: Markov model: predictions and scenarios</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-full toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#the-case-of-pacific-northwest-forests" id="toc-the-case-of-pacific-northwest-forests" class="nav-link active" data-scroll-target="#the-case-of-pacific-northwest-forests">The case of Pacific Northwest Forests</a>
  <ul class="collapse">
  <li><a href="#building-a-markov-model" id="toc-building-a-markov-model" class="nav-link" data-scroll-target="#building-a-markov-model">Building a Markov model</a></li>
  <li><a href="#matrix-projection" id="toc-matrix-projection" class="nav-link" data-scroll-target="#matrix-projection">Matrix Projection</a></li>
  <li><a href="#transition-matrix" id="toc-transition-matrix" class="nav-link" data-scroll-target="#transition-matrix">Transition Matrix</a></li>
  <li><a href="#markov-model" id="toc-markov-model" class="nav-link" data-scroll-target="#markov-model">Markov Model</a></li>
  <li><a href="#alternative-management-scenarios" id="toc-alternative-management-scenarios" class="nav-link" data-scroll-target="#alternative-management-scenarios">Alternative Management Scenarios</a></li>
  </ul></li>
  <li><a href="#part-3.-your-turn" id="toc-part-3.-your-turn" class="nav-link" data-scroll-target="#part-3.-your-turn">Part 3. Your turn!</a></li>
  <li><a href="#conclusions" id="toc-conclusions" class="nav-link" data-scroll-target="#conclusions">Conclusions</a>
  <ul class="collapse">
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content column-page-right" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">GEM500: Markov model: predictions and scenarios</h1>
</div>



<div class="quarto-title-meta column-page-right">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Tommaso Trotto &amp; Jen Baron (tommaso.trotto@ubc.ca) </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">November 6, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="the-case-of-pacific-northwest-forests" class="level1">
<h1>The case of Pacific Northwest Forests</h1>
<p>Much debate over the management of Pacific Northwestern (PNW) forests occurred in the early 1990s. The debate centered on the effects of intensive logging on old-growth forests and on old-growth-dependent wildlife species such as the northern spotted owl (<em>Strix occidentalis</em>) and the marbled murrelet (<em>Brachyramphus marmoratus</em>) (<span class="citation" data-cites="hansen1991">Hansen et al. (<a href="#ref-hansen1991" role="doc-biblioref">1991</a>)</span>, <span class="citation" data-cites="ruggiero1991">Pacific Northwest Research Station (Portland and Ruggiero (<a href="#ref-ruggiero1991" role="doc-biblioref">1991</a>)</span>), primarily on U.S. Forest Service land. Since most of the old-growth on private lands was already gone, most of the old-growth harvested in the 1980s came from these federal lands (<span class="citation" data-cites="harris1984">Harris (<a href="#ref-harris1984" role="doc-biblioref">1984</a>)</span>, <span class="citation" data-cites="robbins2011">Robbins (<a href="#ref-robbins2011" role="doc-biblioref">2011</a>)</span>). By the mid-1990s, harvest was reduced by over 90% on federal lands relative to the peak harvests of the late 1980s (<span class="citation" data-cites="marcot1997">Marcot (<a href="#ref-marcot1997" role="doc-biblioref">1997</a>)</span>). A central question during this time was how long can current rates of harvest be sustained before the old growth is virtually gone?</p>
<p>The Oregon Cascades were at the center of this debate over the management of PNW forests. This area is on federally managed lands where timber harvesting has been conducted using a dispersed (staggered setting) system of 10-20 ha clear-cut patches. The rate and pattern of these disturbances is somewhat different than those on private lands (<span class="citation" data-cites="spies1994">Spies, Ripple, and Bradshaw (<a href="#ref-spies1994" role="doc-biblioref">1994</a>)</span>) and is quite different than disturbances generated by wildfire during the pre-settlement era (<span class="citation" data-cites="wallin1996">Wallin et al. (<a href="#ref-wallin1996" role="doc-biblioref">1996</a>)</span>). Spatial data for this area were derived from Landsat Thematic Mapper data using methods outlined in <span class="citation" data-cites="cohen1995">Cohen, Spies, and Fiorella (<a href="#ref-cohen1995" role="doc-biblioref">1995</a>)</span>, <span class="citation" data-cites="cohen1998">Cohen et al. (<a href="#ref-cohen1998" role="doc-biblioref">1998</a>)</span>, <span class="citation" data-cites="cohen2002">Cohen et al. (<a href="#ref-cohen2002" role="doc-biblioref">2002</a>)</span>, and <span class="citation" data-cites="wallin1997">Wallin et al. (<a href="#ref-wallin1997" role="doc-biblioref">1997</a>)</span>. Forest cover was classified into six approximate age classes (<a href="#tbl-covers" class="quarto-xref">Table&nbsp;1</a>) at 200 random locations based on a Landsat imagery from 1972. The cover type at each of these locations was tallied at time 1 (1972), 2 (1984), and 3 (1991) on the three Landsat scenes. This information is tallied in columns in the spreadsheet <strong>sample200.csv</strong>.</p>
<div id="tbl-covers" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-covers-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Definition of cover types in the Pacific Northwestern forest landscape.
</figcaption>
<div aria-describedby="tbl-covers-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top">
<thead>
<tr>
<th>Class</th>
<th>Age (yr)</th>
<th>Cover Type</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>Background</td>
<td>(Non forest)</td>
</tr>
<tr>
<td>1</td>
<td>0-20</td>
<td>Recent clear-cut</td>
</tr>
<tr>
<td>2</td>
<td>21-40</td>
<td>Early seral</td>
</tr>
<tr>
<td>3</td>
<td>41-80</td>
<td>Mid seral</td>
</tr>
<tr>
<td>4</td>
<td>81-170</td>
<td>Mature</td>
</tr>
<tr>
<td>5</td>
<td>&gt;170</td>
<td>Old growth</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<section id="building-a-markov-model" class="level2">
<h2 class="anchored" data-anchor-id="building-a-markov-model">Building a Markov model</h2>
<p>In this part of the lab, you will build a simple Markov model of landscape change, evaluate it, and use it as a point of departure to consider more realistic (but more complicated) models. Raster maps of Pacific Northwest forests are compared over three time periods to summarize the rates of transition between cover types. A simple model of landscape change is built from these transition probabilities. Lastly, this model is projected forward in time to verify and validate the model.</p>
<p>Let’s begin by importing the libraries we will need. On top of that, note how we are sourcing external files containing functions we will need later. This is a common practice in case you have custom functions you need to use in multiple projects. By storing them on an external file you don’t have to re-write them every time you start a new analysis.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"data/rel.R"</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"data/fix_tm.R"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now we load the data that was sampled across 200 random locations detailing the cover type over 3 years, alongside the animated raster data for the same years (<a href="#fig-gif" class="quarto-xref">Figure&nbsp;1</a>).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/sample200.csv"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>pnw72 <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"data/pnw72.gif"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>pnw84 <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"data/pnw84.gif"</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>pnw91 <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"data/pnw91.gif"</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Sample y1972 y1984 y1991
1      1     1     1     1
2      2     5     5     5
3      3     4     4     4
4      4     5     5     5
5      5     1     1     1
6      6     5     1     1</code></pre>
</div>
</div>
<div id="fig-gif" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-gif-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="data/pnw-change.gif" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-gif-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Change in cover types from 1972, 1984, to 1991.
</figcaption>
</figure>
</div>
</section>
<section id="matrix-projection" class="level2">
<h2 class="anchored" data-anchor-id="matrix-projection">Matrix Projection</h2>
<p>As we learned in the first part of the lab, we construct a <strong>transition matrix</strong> to determine how the landscape will change over 2 time periods. However, let’s start by observing how the proportion of landscape classes varies over time to get a better sense of what we are dealing with.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>n_samples <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 1972</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>t1972 <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="fu">as.factor</span>(data<span class="sc">$</span>y1972)) <span class="co"># tally of each cover type</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>p1972 <span class="ot">&lt;-</span> t1972<span class="sc">/</span>n_samples <span class="co"># proportion of each cover class</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 1984</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>t1984 <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="fu">as.factor</span>(data<span class="sc">$</span>y1984))</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>p1984 <span class="ot">&lt;-</span> t1984<span class="sc">/</span>n_samples</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 1991</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>t1991 <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="fu">as.factor</span>(data<span class="sc">$</span>y1991))</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>p1991 <span class="ot">&lt;-</span> t1991<span class="sc">/</span>n_samples</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>As a second step, we initialize the <strong>transition vector</strong> using the proportion of cover types in the first year (1972). We then construct a matrix with the proportion of each cover type per year (<a href="#tbl-props" class="quarto-xref">Table&nbsp;2</a>).</p>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># initialize transition vector</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>inits <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(p1972)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1972</span>, <span class="dv">1984</span>, <span class="dv">1991</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># prepare cover type matrix</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>props <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">as.vector</span>(p1972), <span class="fu">as.vector</span>(p1984), <span class="fu">as.vector</span>(p1991))</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>props <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">cbind</span>(years, props))  <span class="co"># include years</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(props) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Year"</span>,<span class="st">"C1"</span>,<span class="st">"C2"</span>,<span class="st">"C3"</span>,<span class="st">"C4"</span>,<span class="st">"C5"</span>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>props</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-props" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-props-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: Initial class proportions in 1972, 1984, and 1991.
</figcaption>
<div aria-describedby="tbl-props-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-stdout">
<pre><code>  Year    C1    C2    C3    C4    C5
1 1972 0.185 0.040 0.105 0.215 0.455
2 1984 0.230 0.055 0.100 0.205 0.410
3 1991 0.375 0.055 0.090 0.155 0.325</code></pre>
</div>
</div>
</figure>
</div>
<p>Let’s now explore how the cover types have changed over time. We already have a sense of how, for example, harvesting has increased by looking at <a href="#fig-gif" class="quarto-xref">Figure&nbsp;1</a>. However, let’s display it in a more useful way (<a href="#fig-props" class="quarto-xref">Figure&nbsp;2</a>).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># reformat data in long format to be plotted using ggplot2</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>props_long <span class="ot">&lt;-</span> props <span class="sc">%&gt;%</span> </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"C"</span>), </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"Class"</span>, </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"Proportion"</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(props_long, <span class="fu">aes</span>(<span class="at">x =</span> Year, <span class="at">y =</span> Proportion, <span class="at">col =</span> Class)) <span class="sc">+</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-props" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-props-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-props-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-props-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Change in the proportion of cover types from 1972, 1984, to 1991.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="transition-matrix" class="level2">
<h2 class="anchored" data-anchor-id="transition-matrix">Transition Matrix</h2>
<p>It’s now time to build our transition matrices for the years 1972 -&gt; 1984 and 1984 -&gt; 1991! A transition matrix <span class="math inline">\(M\)</span> is built on top of a tally matrix and dividing each element by the row total. Here, a tally matrix simply counts how many times a cover type in one year (<span class="math inline">\(n_i\)</span>) changed into another type in another year (<span class="math inline">\(n_j\)</span>). For example, we count how many times C1 in 1972 became C2…C5 in 1984 and similarly for the period 1984-1991. Therefore, each cell in the transition matrix can be represented as <span class="math inline">\(n_{ij}\)</span>, where <span class="math inline">\(i\)</span> is the old class and <span class="math inline">\(j\)</span> is the new class.</p>
<p>We can then convert our transition matrix (i.e.&nbsp;a tally matrix of <span class="math inline">\(n_{ij}\)</span>, <a href="#tbl-tm11" class="quarto-xref">Table&nbsp;3</a>) into proportions of cells of each cover type that changed into another cover type during that time interval (<span class="math inline">\(P\)</span>, <a href="#tbl-tm12" class="quarto-xref">Table&nbsp;4</a>, <a href="#tbl-tm2" class="quarto-xref">Table&nbsp;5</a>). This should give us a better sense of how much of each class changed. Remember that the diagonal elements <span class="math inline">\(p_{ii}\)</span> are the class proportions that did not change.</p>
<p>Let’s build <span class="math inline">\(P\)</span> for each time internal. Here, we will use the function <code>rel</code> and <code>fix.steps</code> from the files we sourced earlier, which would help us streamline the build-up of the matrix <span class="math inline">\(P\)</span>. Also, note that we are interested in extracting the transition matrix describing annual changes in class proportions. If we considered the change from 1972 to 1984, we would end up with a transition matrix describing changes over 12 years. To fix that, we have divide the off-diagonal cells (<span class="math inline">\(p_{ij}\)</span>) by the original time frame (12 or 7 years) and adjust the diagonal elements to be <span class="math inline">\(1 - \sum_{j = 1}^{n}p_{ij}\)</span>. That is, make sure the row sum is equal to 1.</p>
<p><strong>1972-1984</strong></p>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># build the tally matrix</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>t7284 <span class="ot">&lt;-</span> <span class="fu">table</span>(data<span class="sc">$</span>y1972, data<span class="sc">$</span>y1984)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>t7284 </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-tm11" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-tm11-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;3: Tally matrix for the years 1972 to 1984.
</figcaption>
<div aria-describedby="tbl-tm11-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-stdout">
<pre><code>   
     1  2  3  4  5
  1 33  4  0  0  0
  2  0  7  1  0  0
  3  0  0 19  2  0
  4  3  0  0 39  1
  5 10  0  0  0 81</code></pre>
</div>
</div>
</figure>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># relativize by row sum </span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>r7284 <span class="ot">&lt;-</span> <span class="fu">rel</span>(t7284)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># fix the 12 year time step into annual steps</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>P <span class="ot">&lt;-</span> <span class="fu">fix.steps</span>(r7284, <span class="dv">12</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>P <span class="sc">%&gt;%</span> <span class="fu">round</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-tm12" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-tm12-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;4: Transition matrix for the years 1972 to 1984 in annual time steps.
</figcaption>
<div aria-describedby="tbl-tm12-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-stdout">
<pre><code>   
        1     2     3     4     5
  1 0.991 0.009 0.000 0.000 0.000
  2 0.000 0.990 0.010 0.000 0.000
  3 0.000 0.000 0.992 0.008 0.000
  4 0.006 0.000 0.000 0.992 0.002
  5 0.009 0.000 0.000 0.000 0.991</code></pre>
</div>
</div>
</figure>
</div>
<p><strong>1984-1991</strong></p>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>t8491 <span class="ot">&lt;-</span> <span class="fu">table</span>(data<span class="sc">$</span>y1984, data<span class="sc">$</span>y1991)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>r8491 <span class="ot">&lt;-</span> <span class="fu">rel</span>(t8491)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>P8491 <span class="ot">&lt;-</span> <span class="fu">fix.steps</span>(r8491, <span class="dv">7</span>) <span class="co"># 7 years between time steps</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>P8491 <span class="sc">%&gt;%</span> <span class="fu">round</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-tm2" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-tm2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;5: Transition matrix for the years 1984 to 1991 in annual time steps.
</figcaption>
<div aria-describedby="tbl-tm2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-stdout">
<pre><code>   
        1     2     3     4     5
  1 1.000 0.000 0.000 0.000 0.000
  2 0.000 1.000 0.000 0.000 0.000
  3 0.014 0.000 0.986 0.000 0.000
  4 0.035 0.000 0.000 0.965 0.000
  5 0.030 0.000 0.000 0.000 0.970</code></pre>
</div>
</div>
</figure>
</div>
</section>
<section id="markov-model" class="level2">
<h2 class="anchored" data-anchor-id="markov-model">Markov Model</h2>
<p>At this point, we have everything we need to build our first-order Markov model! A first-order Markov model assumes that to predict the state of the system at time <span class="math inline">\(t + 1\)</span>, one need only know the state of the system at time <span class="math inline">\(t\)</span> (<span class="citation" data-cites="usher1992">Usher (<a href="#ref-usher1992" role="doc-biblioref">1992</a>)</span>). The core of a Markov model is the transition matrix <span class="math inline">\(P\)</span>, which summarizes the probability that a cell of cover type <span class="math inline">\(i\)</span> will change to cover type <span class="math inline">\(j\)</span> during a single timestep. The timestep is the interval over which the data were observed to change (i.e., the time interval of the two maps, in our case fixed to 1 year).</p>
<p>To explore a Markov model, it is initialized with a state vector and then projected for one or more timesteps. The vector of cover types produced at each iteration is the prediction of overall landscape composition for that timestep. We start by building a matrix which will contain the proportion of classes for each year throughout the length of the projection (999 years).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># build transition matrix for the whole projection</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>ntypes <span class="ot">&lt;-</span> <span class="fu">length</span>(inits) <span class="co"># 5 classes</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>ntimes <span class="ot">&lt;-</span> <span class="dv">999</span> <span class="co"># number of years in projection</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>transient <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> ntimes, <span class="at">ncol =</span> ntypes)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co"># initiate variables for projection</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>begin <span class="ot">&lt;-</span> <span class="dv">1972</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>times <span class="ot">&lt;-</span> <span class="fu">seq</span>(begin <span class="sc">+</span> <span class="dv">1</span>, begin <span class="sc">+</span> <span class="dv">999</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>pass <span class="ot">&lt;-</span> inits <span class="co"># copy inits because we will need it later</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co"># run projection</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(times)) {</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  transient[i, ] <span class="ot">&lt;-</span> pass <span class="sc">%*%</span> P <span class="co"># matrix multiplication in R lingo</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  pass <span class="ot">&lt;-</span> transient[i, ]</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="co"># add the "date" for convenience</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">cbind</span>(times, transient)) </span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">c</span>(begin, inits), out)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="co"># create labels for the output columns:</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(out)<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">"Year"</span>, <span class="fu">paste</span>(<span class="st">"C"</span>, <span class="fu">as.character</span>(<span class="dv">1</span><span class="sc">:</span>ntypes), <span class="at">sep=</span><span class="st">""</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We now validate the model to make sure it’s working as expected. To do that, we can have a quick look at the projection and overlay the actual class proportions we have for the 3 years. However, remember that this is not ideal because our projection runs for almost 1000 years! So, let’s start plotting the actual projection for the year 1972 to 1995 and see what it looks like (<a href="#fig-valid" class="quarto-xref">Figure&nbsp;3</a>).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>out_long <span class="ot">&lt;-</span> out <span class="sc">%&gt;%</span> </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="fu">starts_with</span>(<span class="st">"C"</span>), </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to=</span><span class="st">"Class"</span>, </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to=</span><span class="st">"Proportion"</span>) <span class="co">#convert to "long" format to plot</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data=</span>out_long, <span class="fu">aes</span>(<span class="at">x=</span>Year, <span class="at">y=</span>Proportion, <span class="at">col =</span> Class)) <span class="sc">+</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data=</span>props_long, <span class="fu">aes</span>(<span class="at">x=</span>Year, <span class="at">y=</span>Proportion, <span class="at">col =</span> Class)) <span class="sc">+</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">1972</span>,<span class="dv">1995</span>) <span class="sc">+</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">0</span>,<span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>p1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-valid" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-valid-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-valid-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-valid-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Simulated landscape class changes between 1972 and 1995. Points represent the actual cover type proportions in the years 1972, 1984, and 1991.
</figcaption>
</figure>
</div>
</div>
</div>
<p><strong><em>Question 1. How does the model perform compared to the data? Does this differ by timestep (1972-1984, 1984-1991)?</em></strong></p>
<p>Now, let’s observe the entire simulation until the year 2971 (<a href="#fig-sim" class="quarto-xref">Figure&nbsp;4</a>).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data=</span>out_long, <span class="fu">aes</span>(<span class="at">x=</span>Year, <span class="at">y=</span>Proportion, <span class="at">col =</span> Class)) <span class="sc">+</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>p2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-sim" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-sim-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-sim-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-sim-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Simulated landscape class changes between 1972 and 2971.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="alternative-management-scenarios" class="level2">
<h2 class="anchored" data-anchor-id="alternative-management-scenarios">Alternative Management Scenarios</h2>
<p>The power of the simulation does end here. For example, we can test how alternative management scenario may affect the class proportions in the long run. Imagine a new policy has implemented a reduction by half of the annual allowable cut. That mean we can only harvest as much as we did last year. What would happen to the class proportion in 1000 years?</p>
<p>To do that, we have to manually adjust <span class="math inline">\(P\)</span> to reflect a reduction in the harvesting rate, and therefore an increase in initial proportions for the other cover types. In particular, let’s assume that by reducing harvesting we would have higher initial mature and old growth classes. We can therefore adjust <span class="math inline">\(P\)</span> accordingly as follows (<a href="#tbl-alt1" class="quarto-xref">Table&nbsp;6</a>).</p>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># start with the same probabilities as before</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>P2 <span class="ot">&lt;-</span> P</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># change rate of conversion between harvest and mature (half of current rate)</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>h41 <span class="ot">&lt;-</span> P[<span class="dv">4</span>, <span class="dv">1</span>] <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co"># decrease harvest and increase mature forests</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>P2[<span class="dv">4</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> h41</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>P2[<span class="dv">4</span>,<span class="dv">4</span>] <span class="ot">&lt;-</span> P[<span class="dv">4</span>, <span class="dv">4</span>] <span class="sc">+</span> h41 </span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co"># same for old growth</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>h51 <span class="ot">&lt;-</span> P[<span class="dv">5</span>, <span class="dv">1</span>] <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>P2[<span class="dv">5</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> h51</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>P2[<span class="dv">5</span>,<span class="dv">5</span>] <span class="ot">&lt;-</span> P2[<span class="dv">5</span>, <span class="dv">5</span>] <span class="sc">+</span> h51</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="co"># compare probabilities before and after</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>P <span class="sc">%&gt;%</span> <span class="fu">round</span>(<span class="dv">3</span>)</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>P2 <span class="sc">%&gt;%</span> <span class="fu">round</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-alt1" class="quarto-layout-panel anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-alt1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;6: Transition matrices for the years 1972 to 1984 in annual time steps with (right) and without (left) adjusted proportions to reflect reduction in harvesting rate.
</figcaption>
<div aria-describedby="tbl-alt1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output cell-output-stdout quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<pre><code>   
        1     2     3     4     5
  1 0.991 0.009 0.000 0.000 0.000
  2 0.000 0.990 0.010 0.000 0.000
  3 0.000 0.000 0.992 0.008 0.000
  4 0.006 0.000 0.000 0.992 0.002
  5 0.009 0.000 0.000 0.000 0.991</code></pre>
</div>
<div class="cell-output cell-output-stdout quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<pre><code>   
        1     2     3     4     5
  1 0.991 0.009 0.000 0.000 0.000
  2 0.000 0.990 0.010 0.000 0.000
  3 0.000 0.000 0.992 0.008 0.000
  4 0.003 0.000 0.000 0.995 0.002
  5 0.005 0.000 0.000 0.000 0.995</code></pre>
</div>
</div>
</div>
</figure>
</div>
<p>Now we run the new projection and visualize it.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># prepare transition matrix</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>transient2 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> ntimes, <span class="at">ncol =</span> ntypes)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>pass <span class="ot">&lt;-</span> inits</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co"># run projection</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(times)) {</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  transient2[i, ] <span class="ot">&lt;-</span> pass <span class="sc">%*%</span> P2</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  pass <span class="ot">&lt;-</span> transient2[i, ]</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="co"># prepare output for plotting</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>out2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">cbind</span>(times, transient2))</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>out2 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">c</span>(begin, inits), out2)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(out2) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Year"</span>, <span class="fu">paste</span>(<span class="st">"C"</span>, <span class="fu">as.character</span>(<span class="dv">1</span><span class="sc">:</span>ntypes), <span class="at">sep=</span><span class="st">""</span>))</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>out_long2 <span class="ot">&lt;-</span> out2 <span class="sc">%&gt;%</span> </span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="fu">starts_with</span>(<span class="st">"C"</span>), </span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to=</span><span class="st">"Class"</span>, </span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to=</span><span class="st">"Proportion"</span>)</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data=</span>out_long2, <span class="fu">aes</span>(<span class="at">x=</span>Year, <span class="at">y=</span>Proportion, <span class="at">col=</span>Class)) <span class="sc">+</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>p3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-sim2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-sim2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-sim2-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-sim2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Simulated landscape class changes between 1972 and 2971 using a half harvesting rate scenario.
</figcaption>
</figure>
</div>
</div>
</div>
<p>We can then compare the projections by plotting them together (<a href="#fig-t" class="quarto-xref">Figure&nbsp;6</a>).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>p2 <span class="sc">/</span> p3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-t" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-t-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-t-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-t-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Comparison of Markov projections for 2 management scenarios.
</figcaption>
</figure>
</div>
</div>
</div>
<p><strong><em>Question 2. Briefly describe how the different management scenarios produce different outcomes in terms of landscape composition.</em></strong></p>
<p>Finally, let’s look more closely at old growth forests and how their proportion is affected by a different management scenario until the end of the century (<a href="#fig-compare" class="quarto-xref">Figure&nbsp;7</a>).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data=</span>out, <span class="fu">aes</span>(<span class="at">x=</span>Year, <span class="at">y=</span>C5, <span class="at">col =</span> <span class="st">"a"</span>), <span class="at">size=</span><span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data=</span>out2, <span class="fu">aes</span>(<span class="at">x=</span>Year, <span class="at">y=</span>C5, <span class="at">col =</span> <span class="st">"b"</span>), <span class="at">size=</span><span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">name =</span> <span class="st">'Harvesting Rate'</span>,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">values=</span><span class="fu">c</span>(<span class="st">'a'</span><span class="ot">=</span><span class="st">'darkgreen'</span>,<span class="st">'b'</span><span class="ot">=</span><span class="st">'saddlebrown'</span>), </span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"1972-84 rate"</span>,<span class="st">"50% haervesting rate"</span>)) <span class="sc">+</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fl">0.1</span>,<span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">1970</span>,<span class="dv">2100</span>), <span class="at">n.breaks=</span><span class="dv">8</span>) <span class="sc">+</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Proportion Old Growth"</span>) <span class="sc">+</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-compare" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-compare-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-compare-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-compare-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Comparison of old-growth proportion under 2 different management scenarios until the end of the century.
</figcaption>
</figure>
</div>
</div>
</div>
<p><strong><em>Question 3. Based on the results of the first Markov model, do you think that the 1982-1984 rates of harvest are sustainable for old-growth forests?</em></strong></p>
<p><strong><em>Question 4. Using 3 bullet points, what scenarios could be applied to a Markov model to incorporate more complex and realistic mechanisms of landscape change?</em></strong></p>
</section>
</section>
<section id="part-3.-your-turn" class="level1">
<h1>Part 3. Your turn!</h1>
<p>We explored the use of alternative management scenarios and how these affect the class proportions over time. For this part, run an alternative management scenario that allows you to retain <em>30% of old growth</em> forest at the end of the century. What other class proportions would you need to change in order to attain this management goal? Feel free to re-use the provided code or write your own implementation (whichever programming language you prefer).</p>
<p><strong><em>Question 5. Upon completion of your scenarios, submit your plotted simulation. Briefly use bullet point to list what assumption you had to make when developing a simple first-order Markov model?</em></strong></p>
</section>
<section id="conclusions" class="level1">
<h1>Conclusions</h1>
<p>This concludes the development, verification, and validation of a simple Markov model of landscape change. In some applications, such a simple model is sufficient. But in many cases, this simple model serves as a point of departure for more complicated models. In particular, some consideration of the assumptions and limitations of Markov models can be a useful aid in interpreting the behavior and predictions of other models.</p>
<section id="references" class="level3">
<h3 class="anchored" data-anchor-id="references">References</h3>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-cohen1998" class="csl-entry" role="listitem">
Cohen, Warren B, Maria Fiorella, John Gray, Eileen Helmer, and Karen Anderson. 1998. <span>“An Efficient and Accurate Method for Mapping Forest Clearcuts in the Pacific Northwest Using Landsat Imagery.”</span> <em>Photogrammetric Engineering and Remote Sensing</em> 64 (4): 293–99.
</div>
<div id="ref-cohen2002" class="csl-entry" role="listitem">
Cohen, Warren B, Thomas A Spies, Ralph J Alig, Douglas R Oetter, Thomas K Maiersperger, and Maria Fiorella. 2002. <span>“Characterizing 23 Years (1972–95) of Stand Replacement Disturbance in Western Oregon Forests with Landsat Imagery.”</span> <em>Ecosystems</em> 5: 122–37.
</div>
<div id="ref-cohen1995" class="csl-entry" role="listitem">
Cohen, Warren B, Thomas A Spies, and Maria Fiorella. 1995. <span>“Estimating the Age and Structure of Forests in a Multi-Ownership Landscape of Western Oregon, USA.”</span> <em>International Journal of Remote Sensing</em> 16 (4): 721–46.
</div>
<div id="ref-hansen1991" class="csl-entry" role="listitem">
Hansen, Andrew J, Thomas A Spies, Frederick J Swanson, and Janet L Ohmann. 1991. <span>“Conserving Biodiversity in Managed Forests.”</span> <em>BioScience</em> 41 (6): 382–92.
</div>
<div id="ref-harris1984" class="csl-entry" role="listitem">
Harris, Larry D. 1984. <em>The Fragmented Forest: Island Biogeography Theory and the Preservation of Biotic Diversity</em>. University of Chicago press.
</div>
<div id="ref-marcot1997" class="csl-entry" role="listitem">
Marcot, Bruce G. 1997. <em>Of Spotted Owls, Old Growth, and New Policies: A History Since the Interagency Scientific Committee Report</em>. Vol. 408. US Department of Agriculture, Forest Service, Pacific Northwest Research Station.
</div>
<div id="ref-ruggiero1991" class="csl-entry" role="listitem">
Pacific Northwest Research Station (Portland, Or.), and Leonard F Ruggiero. 1991. <em>Wildlife and Vegetation of Unmanaged Douglas-Fir Forests</em>. The Station.
</div>
<div id="ref-robbins2011" class="csl-entry" role="listitem">
Robbins, William G. 2011. <em>Hard Times in Paradise: Coos Bay, Oregon</em>. University of Washington Press.
</div>
<div id="ref-spies1994" class="csl-entry" role="listitem">
Spies, Thomas A, William J Ripple, and GA Bradshaw. 1994. <span>“Dynamics and Pattern of a Managed Coniferous Forest Landscape in Oregon.”</span> <em>Ecological Applications</em> 4 (3): 555–68.
</div>
<div id="ref-usher1992" class="csl-entry" role="listitem">
Usher, Michael B. 1992. <span>“Statistical Models of Succession.”</span> <em>Plant Succession: Theory and Prediction</em> 11: 215.
</div>
<div id="ref-wallin1997" class="csl-entry" role="listitem">
Wallin, David O, Mark E Harmon, Warren B Cohen, Maria Fiorella, and William K Ferrell. 1997. <span>“Use of Remote Sensing to Model Land Use Effects on Carbon Flux in Forests of the Pacific Northwest, USA.”</span> <em>The Use of Remote Sensing in the Modeling of Forest Productivity</em>, 219–37.
</div>
<div id="ref-wallin1996" class="csl-entry" role="listitem">
Wallin, David O, Frederick J Swanson, Barbara Marks, John H Cissel, and Jane Kertis. 1996. <span>“Comparison of Managed and Pre-Settlement Landscape Dynamics in Forests of the Pacific Northwest, USA.”</span> <em>Forest Ecology and Management</em> 85 (1-3): 291–309.
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>