---
title: "GEM500: Markov model: predictions and scenarios"
author: "Tommaso Trotto & Jen Baron (tommaso.trotto@ubc.ca)"
affiliation: "University of British Columbia, Department of Forest Resource Management"
date: "11/6/2024"
bibliography: references.bib
format:
  html:
    page-layout: full
    code-fold: true
    theme: flatly
    toc: true
    toc-float: true
    toc-location: left
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

# The case of Pacific Northwest Forests

Much debate over the management of Pacific Northwestern (PNW) forests occurred in the early 1990s. The debate centered on the effects of intensive logging on old-growth forests and on old-growth-dependent wildlife species such as the northern spotted owl (*Strix occidentalis*) and the marbled murrelet (*Brachyramphus marmoratus*) (@hansen1991, @ruggiero1991), primarily on U.S. Forest Service land. Since most of the old-growth on private lands was already gone, most of the old-growth harvested in the 1980s came from these federal lands (@harris1984, @robbins2011). By the mid-1990s, harvest was reduced by over 90% on federal lands relative to the peak harvests of the late 1980s (@marcot1997). A central question during this time was how long can current rates of harvest be sustained before the old growth is virtually gone?

The Oregon Cascades were at the center of this debate over the management of PNW forests. This area is on federally managed lands where timber harvesting has been conducted using a dispersed (staggered setting) system of 10-20 ha clear-cut patches. The rate and pattern of these disturbances is somewhat different than those on private lands (@spies1994) and is quite different than disturbances generated by wildfire during the pre-settlement era (@wallin1996). Spatial data for this area were derived from Landsat Thematic Mapper data using methods outlined in @cohen1995, @cohen1998, @cohen2002, and @wallin1997. Forest cover was classified into six approximate age classes (@tbl-covers) at 200 random locations based on a Landsat imagery from 1972. The cover type at each of these locations was tallied at time 1 (1972), 2 (1984), and 3 (1991) on the three Landsat scenes. This information is tallied in columns in the spreadsheet **sample200.csv**.

| Class | Age (yr)   | Cover Type       |
|-------|------------|------------------|
| 0     | Background | (Non forest)     |
| 1     | 0-20       | Recent clear-cut |
| 2     | 21-40      | Early seral      |
| 3     | 41-80      | Mid seral        |
| 4     | 81-170     | Mature           |
| 5     | \>170      | Old growth       |
: Definition of cover types in the Pacific Northwestern forest landscape. {#tbl-covers}

# Building a Markov model

One common way to study temporal changes in the landscape is via a **Markov model**. In this part of the lab, you will build a simple Markov model of landscape change, evaluate it, and use it as a point of departure to consider more realistic (but more complicated) models. Raster maps of Pacific Northwest forests are compared over three time periods to summarize the rates of transition between cover types. A simple model of landscape change is built from these transition probabilities. Lastly, this model is projected forward in time to verify and validate the model. Remember that a Markov model is such that, given an initial state $x_t = [x_1, x_2, x_3, ..., x_n]$ and a transition matrix of probabilities $P$, $x_{t+1} = x_t * P$.

Let's begin by importing the libraries we will need. On top of that, note how we are sourcing external files containing functions we will need later on. This is a common practice in case you have custom functions you need to use in multiple projects. By storing them on a external files you don't have to re-write the function every time you start a new project.

```{r libs}
#| warning: false

library(tidyr)
library(ggplot2)
library(dplyr)
library(terra)
library(patchwork)

source("data/rel.R")
source("data/fix_tm.R")
```

Now we load the data that was sampled across 200 random locations detailing the cover type over 3 years, alongside the animated raster data for the same years (@fig-gif).

```{r read}
data <- read.csv("data/sample200.csv")
pnw72 <- rast("data/pnw72.gif")
pnw84 <- rast("data/pnw84.gif")
pnw91 <- rast("data/pnw91.gif")

head(data)
```

![Change in cover types from 1972, 1984, to 1991.](data/pnw-change.gif){#fig-gif}

## Matrix Projection

As we discussed in the first part of the lab, we construct a **transition matrix** to determine how the landscape will change over 2 time periods. However, let's start by observing how the proportion of landscape classes varies over time to get a better sense of what we are dealing with.

```{r proj}
n_samples <- nrow(data)

# 1972
t1972 <- table(as.factor(data$y1972)) # tally of each cover type
p1972 <- t1972 / n_samples # proportion of each cover class

# 1984
t1984 <- table(as.factor(data$y1984))
p1984 <- t1984 / n_samples

# 1991
t1991 <- table(as.factor(data$y1991))
p1991 <- t1991 / n_samples
```

As a second step, we initialize the **transition vector** using the proportion of cover types in the first year (1972). We then construct a matrix with the proportion of each cover type per year (@tbl-props).

``` {r proportions}
#| tbl-cap: "Initial class proportions in 1972, 1984, and 1991."
#| label: tbl-props

# initialize transition vector
inits <- as.vector(p1972)
years <- c(1972, 1984, 1991)

# prepare cover type matrix
props <- rbind(as.vector(p1972), as.vector(p1984), as.vector(p1991))
props <- data.frame(cbind(years, props))  # include years
names(props) <- c("Year","C1","C2","C3","C4","C5")

props
```

Let's now explore how the cover types have changed over time. We already have a sense of how, for example, harvesting has increased by looking at @fig-gif. However, let's display it in a more useful way (@fig-props). 

```{r plot}
#| fig-cap: "Change in the proportion of cover types from 1972, 1984, to 1991."
#| label: fig-props

# reformat data in long format to be plotted using ggplot2
props_long <- props %>% 
  pivot_longer(cols = starts_with("C"), 
               names_to = "Class", 
               values_to = "Proportion")

ggplot(props_long, aes(x = Year, y = Proportion, col = Class)) +
  geom_line() +
  geom_point() +
  theme_classic()
```


## Transition Matrix

It's now time to build our transition matrices for the years 1972 -> 1984 and 1984 -> 1991! A transition matrix $M$ is built on top of a tally matrix and dividing each element by the row total. Here, a tally matrix simply counts how many times a cover type in one year ($n_i$) changed into another type in another year ($n_j$). For example, we count how many times C1 in 1972 became C2...C5 in 1984 and similarly for the period 1984-1991. Therefore, each cell in the transition matrix can be represented as $n_{ij}$, where $i$ is the old class and $j$ is the new class.

We can then convert our transition matrix (i.e. a tally matrix of $n_{ij}$, @tbl-tm11) into proportions of cells of each cover type that changed into another cover type during that time interval ($P$, @tbl-tm12, @tbl-tm2). This should give us a better sense of how much of each class changed. Remember that the diagonal elements $p_{ii}$ are the class proportions that did not change.

Let's build $P$ for each time internal. Here, we will use the function `rel` and `fix.steps` from the files we sourced earlier, which would help us streamline the building of the matrix $P$. Also, note that we are interested in extracting the transition matrix describing annual changes in class proportions. If we considered the change from 1972 to 1984, we would end up with a transition matrix describing changes over 12 years. To fix that, we have divide the off-diagonal cells ($p_{ij}$) by the original time frame (12 or 7 years) and adjust the diagonal elements to be $1 - \sum_{j = 1}^{n}p_{ij}$. That is, make sure the row sum is equal to 1.

**1972-1984**

```{r tm1-1}
#| tbl-cap: "Tally matrix for the years 1972 to 1984."
#| label: tbl-tm11

# build the tally matrix
t7284 <- table(data$y1972, data$y1984)
t7284 
```

``` {r tm1-2}
#| tbl-cap: "Transition matrix for the years 1972 to 1984 in annual time steps."
#| label: tbl-tm12

# relativize by row sum 
r7284 <- rel(t7284)

# fix the 12 year time step into annual steps
P <- fix.steps(r7284, 12)

P %>% round(3)
```

**1984-1991**

```{r tm2}
#| tbl-cap: "Transition matrix for the years 1984 to 1991 in annual time steps."
#| label: tbl-tm2

t8491 <- table(data$y1984, data$y1991)
r8491 <- rel(t8491)
P8491 <- fix.steps(r8491, 7) # 7 years between time steps

P8491 %>% round(3)
```

## Markov Model

At this point, we have everything we need to build our first-order Markov model! A first-order Markov model assumes that to predict the state of the system at time $t + 1$, one need only know the state of the system at time $t$ (@usher1992). The core of a Markov model is the transition matrix $P$, which summarizes the probability that a cell of cover type $i$ will change to cover type $j$ during a single timestep. The timestep is the interval over which the data were observed to change (i.e., the time interval of the two maps, in our case fixed to 1 year).

To explore a Markov model, we initialized a state vector and we'll then project that for one or more timesteps based on $P$. The vector of cover types produced at each iteration is the prediction of overall landscape composition for that timestep. We start by building a matrix which will contain the proportion of classes for each year throughout the length of the projection (999 years).

```{r transient}
# build transition matrix for the whole projection
ntypes <- length(inits) # 5 classes
ntimes <- 999 # number of years in projection
transient <- matrix(nrow = ntimes, ncol = ntypes)

# initiate variables for projection
begin <- 1972
times <- seq(begin + 1, begin + 999)
pass <- inits # copy inits because we will need it later

# run projection
for (i in seq_along(times)) {
  transient[i, ] <- pass %*% P # matrix multiplication in R lingo
  pass <- transient[i, ]
}

# add the "date" for convenience
out <- data.frame(cbind(times, transient)) 
out <- rbind(c(begin, inits), out)

# create labels for the output columns:
names(out) <- c("Year", paste("C", as.character(1:ntypes), sep=""))
```

We now validate the model to make sure it's working as expected. To do that, we can have a quick look at the projection and overlay the actual class proportions we have for the 3 years. However, remember that this is not ideal because our projection runs for almost 1000 years! So, let's start plotting the actual projection for the year 1972 to 1995 and see what it looks like (@fig-valid).

```{r validate}
#| fig-cap: "Simulated landscape class changes between 1972 and 1995. Points represent the actual cover type proportions in the years 1972, 1984, and 1991."
#| label: fig-valid

out_long <- out %>% 
  pivot_longer(cols=starts_with("C"), 
               names_to="Class", 
               values_to="Proportion") #convert to "long" format to plot
p1 <- ggplot() +
  geom_line(data=out_long, aes(x=Year, y=Proportion, col = Class)) +
  geom_point(data=props_long, aes(x=Year, y=Proportion, col = Class)) +
  xlim(1972,1995) +
  ylim(0,0.5) +
  theme_classic()
p1
```

***Question 1. How does the model perform compared to the data? Does this differ by timestep (1972-1984, 1984-1991)?***

Below you can see the entire simulation until the year 2971 (end of the projection) (@fig-sim).

```{r simulation}
#| fig-cap: "Simulated landscape class changes between 1972 and 2971."
#| label: fig-sim

p2 <- ggplot() +
  geom_line(data=out_long, aes(x=Year, y=Proportion, col = Class)) +
  theme_classic()
p2
```


## Alternative Management Scenarios

The power of the simulation does not end here. For example, we can test how alternative management scenario may affect the class proportions in the long run. Imagine a new policy has implemented a reduction by half of the annual allowable cut. That means we can only harvest half of what we did last year. What would happen to the class proportion in 1000 years?

To do that, we have to manually adjust $P$ to reflect a reduction in the harvesting rate, and therefore an increase in initial proportions for the other cover types. In particular, let's assume that by reducing harvesting we would have higher initial mature and old growth classes. We can therefore adjust $P$ accordingly, as follows (@tbl-alt1).


```{r alternative1}
#| tbl-cap: "Transition matrices for the years 1972 to 1984 in annual time steps with (right) and without (left) adjusted proportions to reflect reduction in harvesting rate."
#| tbl-subcap:
#|   - "Original transition matrix"
#|   - "Alternative transition matrix"
#| label: tbl-alt1
#| layout-ncol: 2

# start with the same probabilities as before
P2 <- P

# change rate of conversion between harvest and mature (half of current rate)
h41 <- P[4, 1] / 2

# decrease harvest and increase mature forests
P2[4,1] <- h41
P2[4,4] <- P[4, 4] + h41 

# same for old growth
h51 <- P[5, 1] / 2
P2[5,1] <- h51
P2[5,5] <- P2[5, 5] + h51

# compare probabilities before and after
P %>% round(3)
P2 %>% round(3)
```

Now we run the new projection and visualize it.

```{r iter2}
#| fig-cap: "Simulated landscape class changes between 1972 and 2971 using a half harvesting rate scenario."
#| label: fig-sim2

# prepare transition matrix
transient2 <- matrix(nrow = ntimes, ncol = ntypes)
pass <- inits


# run projection
for (i in seq_along(times)) {
  transient2[i, ] <- pass %*% P2
  pass <- transient2[i, ]
}

# prepare output for plotting
out2 <- data.frame(cbind(times, transient2))
out2 <- rbind(c(begin, inits), out2)

names(out2) <- c("Year", paste("C", as.character(1:ntypes), sep=""))

# plot
out_long2 <- out2 %>% 
  pivot_longer(cols=starts_with("C"), 
               names_to="Class", 
               values_to="Proportion")
p3 <- ggplot() +
  geom_line(data=out_long2, aes(x=Year, y=Proportion, col=Class)) +
  theme_classic()
p3
```

We can then compare the projections by plotting them together (@fig-t).

``` {r together}
#| fig-cap: "Comparison of Markov projections for 2 management scenarios."
#| label: fig-t
#| fig-width: 7
#| fig-height: 10

p2 / p3
```
***Question 2. Briefly describe how the different management scenarios produce different outcomes in terms of landscape composition.***

Finally, let's look more closely at old growth forests and how their proportion is affected by a different management scenario until the end of the century (@fig-compare).

```{r compare}
#| fig-cap: "Comparison of old-growth proportion under 2 different management scenarios until the end of the century."
#| label: fig-compare

ggplot() +
  geom_line(data=out, aes(x=Year, y=C5, col = "a"), size=0.8) +
  geom_line(data=out2, aes(x=Year, y=C5, col = "b"), size=0.8) +
  scale_colour_manual(name = 'Harvesting Rate',
         values=c('a'='darkgreen','b'='saddlebrown'), 
         labels = c("1972-84 rate","50% haervesting rate")) +
  ylim(0.1,0.5) +
  scale_x_continuous(limits = c(1970,2100), n.breaks=8) +
  labs(y = "Proportion Old Growth") +
  theme_classic()
```

***Question 3. Based on the results of the first Markov model, do you think that the 1982-1984 rates of harvest are sustainable for old-growth forests?***

***Question 4. Using 3 bullet points, what scenarios could be applied to a Markov model to incorporate more complex and realistic mechanisms of landscape change?***


# Part 3. Your turn!

We explored the use of alternative management scenarios and how these affect the class proportions over time. For this part, run an alternative management scenario that allows you to retain **30% of old growth** forest at the end of the century. What other class proportions would you need to change in order to attain this management goal? Feel free to re-use the provided code or write your own implementation (whichever programming language you prefer).

***Question 5. Upon completion of your scenarios, submit your plotted simulation. Briefly use bullet point to list what assumptions you had to make when developing a simple first-order Markov model?***

# Conclusions

This concludes the development, verification, and validation of a simple Markov model of landscape change. In some applications, such a simple model is sufficient. But in many cases, this simple model serves as a point of departure for more complicated models. In particular, some consideration of the assumptions and limitations of Markov models can be a useful aid in interpreting the behavior and predictions of other models.

### References

::: {#refs}
:::

